#!/bin/bash

# exec 200>/tmp/custom_wake.lock
# flock -n 200 || exit 0

if [ "$(/opt/homebrew/bin/yabai -m query --displays | /opt/homebrew/bin/jq -r '.[0]."uuid"')" = "37D8832A-2D66-02CA-B9F7-8F30A301B230" ]; then
    /opt/homebrew/bin/SwitchAudioSource -s "MacBook Pro Speakers" &> /dev/null
else
    /opt/homebrew/bin/SwitchAudioSource -s "SoundID Reference" &> /dev/null
    sleep 1
    /opt/homebrew/bin/sendmidi dev "IAC Driver SID" cc 1 1
    sleep 1
    /opt/homebrew/bin/sendmidi dev "IAC Driver SID" cc 0 127
fi
sleep 1
# if [[ $(/opt/homebrew/bin/yabai -m query --displays | /opt/homebrew/bin/jq length) -eq 2 ]]; then
if [[ "$(/opt/homebrew/bin/SwitchAudioSource -c)" == "SoundID Reference" ]]; then
    /opt/homebrew/bin/skhd -k "shift + alt - f16"
fi
/opt/homebrew/bin/sketchybar --reload
sleep 1
/opt/homebrew/bin/yabai --restart-service
sleep 1
# /opt/homebrew/bin/sketchybar --set audio icon.color=0xff4e4e4e
# /opt/homebrew/bin/sketchybar --set audio label.color=0xff4e4e4e
sudo killall coreaudiod
# while ! pgrep -x "coreaudiod" > /dev/null; do
#     sleep 0.1
# done
# /opt/homebrew/bin/sketchybar --set audio icon.color=0xffc7c7c7
# /opt/homebrew/bin/sketchybar --set audio label.color=0xffc7c7c7
