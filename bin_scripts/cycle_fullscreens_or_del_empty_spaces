#!/bin/bash

trap 'yabai -m config mouse_follows_focus off' EXIT
SPACES=$(yabai -m query --spaces)
CURRENT_SPACE_INDEX=$(echo "$SPACES" | jq '.[] | select(."has-focus") | .index')
FULLSCREENS=$(echo "$SPACES" | jq '[.[] | select(."is-native-fullscreen")]')
if [[ -z "$FULLSCREENS" || "$(echo "$FULLSCREENS" | jq 'length')" -eq 0 ]]; then
    echo "$SPACES" | jq -r '.[] | select(.windows == []) | .index' | sort -nr | xargs -I {} yabai -m space {} --destroy
    sleep 0.1
    sketchybar --update
    exit 1
fi
NEXT_FULLSCREEN_INDEX=$(echo "$FULLSCREENS" | jq --argjson current "$CURRENT_SPACE_INDEX" 'map(select(.index > $current))[0].index // map(.index)[0]')
if [[ -z "$NEXT_FULLSCREEN_INDEX" || "$NEXT_FULLSCREEN_INDEX" == "null" ]]; then
    exit 1
fi
yabai -m config mouse_follows_focus on
yabai -m space --focus "$NEXT_FULLSCREEN_INDEX" || exit 1

# SPACES=$(yabai -m query --spaces)
# CURRENT_SPACE_INDEX=$(echo "$SPACES" | jq '.[] | select(."has-focus") | .index')
# FULLSCREENS=$(echo "$SPACES" | jq '[.[] | select(."is-native-fullscreen")]')
# if [[ -z "$FULLSCREENS" || "$(echo "$FULLSCREENS" | jq 'length')" -eq 0 ]]; then
#     echo "$SPACES" | jq -r '.[] | select(.windows == []) | .index' | sort -nr | xargs -I {} yabai -m space {} --destroy
#     sleep 0.1
#     sketchybar --update
#     exit 1
# fi
# NEXT_FULLSCREEN_INDEX=$(echo "$FULLSCREENS" | jq --argjson current "$CURRENT_SPACE_INDEX" 'map(select(.index > $current))[0].index // map(.index)[0]')
# if [[ -z "$NEXT_FULLSCREEN_INDEX" || "$NEXT_FULLSCREEN_INDEX" == "null" ]]; then
#     exit 1
# fi
# yabai -m config mouse_follows_focus on
# (yabai -m space --focus "$NEXT_FULLSCREEN_INDEX" && yabai -m config mouse_follows_focus off) || exit 1

## SPACES=$(yabai -m query --spaces)
## CURRENT_SPACE_INDEX=$(echo "$SPACES" | jq '.[] | select(."has-focus") | .index')
## FULLSCREENS=$(echo "$SPACES" | jq '[.[] | select(."is-native-fullscreen")]')
## FULLSCREEN_COUNT=$(echo "$FULLSCREENS" | jq 'length')
## NEXT_FULLSCREEN_INDEX=$(echo "$FULLSCREENS" | jq --argjson current "$CURRENT_SPACE_INDEX" 'map(select(.index > $current))[0].index // map(.index)[0]')
## if [[ "$FULLSCREEN_COUNT" -eq 0 ]]; then
##     echo "$SPACES" | jq -r '.[] | select(.windows == []) | .index' | sort -nr | xargs -I {} yabai -m space {} --destroy
##     sleep 0.1
##     sketchybar --update
##     exit 1
## fi
## if [[ -z "$NEXT_FULLSCREEN_INDEX" || "$NEXT_FULLSCREEN_INDEX" == "null" ]]; then
##     exit 1
## fi
## yabai -m space --focus "$NEXT_FULLSCREEN_INDEX" || exit 1
## # yabai -m config mouse_follows_focus on
## # (yabai -m space --focus "$NEXT_FULLSCREEN_INDEX" && yabai -m config mouse_follows_focus off) || exit 1
## # WHY?

# ################!/bin/bash

# yabai -m config mouse_follows_focus on # alttab
# FULLSCREENS="$(yabai -m query --spaces | jq 'map(select(.["is-native-fullscreen"] == true))')"
# # alternative: FULLSCREENS="$(yabai -m query --spaces --display | jq 'map(select(.["is-native-fullscreen"] == true))')" # Ã¼berall oder nur auf aktivem display?
# CURRENT_SPACE_INDEX="$(yabai -m query --spaces --space | jq '.index')"
# NEXT_FULLSCREEN_INDEX=$(echo "$FULLSCREENS" | jq --argjson current "$CURRENT_SPACE_INDEX" 'map(select(.index > $current))[0].index // map(.index)[0]')
# [[ -n "$NEXT_FULLSCREEN_INDEX" ]]
# yabai -m space --focus "$NEXT_FULLSCREEN_INDEX" || return
# yabai -m config mouse_follows_focus off # alttab
