#!/bin/bash

CURRENT_APP=$(yabai -m query --windows --window | jq -r '.app')
CURRENT_APP_ALT=$(sketchybar --query front_app | jq -r '.icon.value')
# CURRENT_DISPLAY=$(yabai -m query --displays --display | jq '.index')
# CURRENT_DISPLAY=$(yabai -m query --windows --window | jq -r '."display"')
## CURRENT_SPACE=$(yabai -m query --windows --window | jq -r '."space"')
# CURRENT_SPACE=$(yabai -m query --spaces --space | jq '.index')
if [[ "$CURRENT_APP" == *WhatsApp* ]]; then
    killall WhatsApp &> /dev/null
elif [[ "$CURRENT_APP_ALT" == "Finder" ]]; then
    skhd -k "cmd - w"
elif [[ "$CURRENT_APP_ALT" == "LogiTune" ]]; then
    sketchybar --set logi icon.color=0xff4e4e4e
    osascript -e 'tell application "Logi Tune" to quit'
    sketchybar --update
elif [[ "$CURRENT_APP_ALT" == "Threema Beta" ]]; then
    killall ThreemaDesktop &> /dev/null
elif [[ "$CURRENT_APP_ALT" == "Thunderbird" ]]; then
    killall thunderbird &> /dev/null
    sleep 0.1
    ~/.config/sketchybar/plugins/badge.sh
elif [[ "$CURRENT_APP_ALT" == "OBS Studio" ]]; then
    osascript -e 'tell application "OBS" to quit'
elif [[ "$CURRENT_APP_ALT" == "TotalMix FX" ]]; then
    osascript -e 'tell application "TotalMix FX" to quit'
    yabai -m window --focus mouse
    exit
elif [[ "$CURRENT_APP_ALT" == "zoom.us" ]]; then
    killall zoom.us
elif [[ "$CURRENT_APP_ALT" == "LibreOffice" ]]; then
    osascript -e "tell application \"LibreOffice\" to quit"
else
    skhd -k "cmd - q"
fi
sleep 0.37
# yabai -m display $CURRENT_DISPLAY
## yabai -m space --focus $CURRENT_SPACE
### if [[ $(yabai -m query --displays --display | jq -r '."uuid"') == "37D8832A-2D66-02CA-B9F7-8F30A301B230" ]]; then
if [[ $(yabai -m query --displays --window | jq -r '."uuid"') == "37D8832A-2D66-02CA-B9F7-8F30A301B230" ]]; then # exactly the opposite of change_and_focus_display
    cliclick m:3460,603 # (+19)
    # cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) + 19 | floor)"')
else
    cliclick m:1280,720
    # cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) | floor)"')
fi
sleep 0.01
# if [[ $(yabai -m query --displays --display | jq -r '."uuid"') == "37D8832A-2D66-02CA-B9F7-8F30A301B230" ]]; then
#     cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) + 19 | floor)"')
# else
#     cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) | floor)"')
# fi
## if [[ $(yabai -m query --displays --display | jq -r '."uuid"') == "37D8832A-2D66-02CA-B9F7-8F30A301B230" ]]; then cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) + 19 | floor)"'); else cliclick $(yabai -m query --displays --display | jq -r '.frame | "m:\(.x + (.w/2) | floor),\(.y + (.h/2) | floor)"'); fi
sleep 0.01
yabai -m window --focus mouse || (cliclick c:. && osascript -e 'tell application "System Events" to set visible of every process whose visible is false to true')
sleep 0.01
skhd -k "fn - x"
sleep 0.1
sketchybar --update
